# Deva æ•°æ®æºç®¡ç†æŒ‡å—

## ğŸ“– æ¦‚è¿°

Deva æ•°æ®æºç®¡ç†ç³»ç»Ÿæä¾›ç»Ÿä¸€çš„æ•°æ®é‡‡é›†ã€å¤„ç†å’Œåˆ†å‘åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§æ•°æ®æºç±»å‹å’Œ AI ä»£ç ç”Ÿæˆã€‚

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ•°æ®æºç®¡ç†æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DataSourcePanel (æ•°æ®æºé¢æ¿ - UI å±‚)             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  - æ•°æ®æºåˆ—è¡¨                                    â”‚   â”‚
â”‚  â”‚  - æ•°æ®æºè¯¦æƒ…                                    â”‚   â”‚
â”‚  â”‚  - æ•°æ®æºç¼–è¾‘                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DataSourceManager (æ•°æ®æºç®¡ç†å™¨)                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  - CRUD æ“ä½œ                                     â”‚   â”‚
â”‚  â”‚  - çŠ¶æ€ç®¡ç†                                      â”‚   â”‚
â”‚  â”‚  - è¡€ç¼˜å…³ç³»                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DataSource (æ•°æ®æºåŸºç±»)                         â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  - fetch_data()                                  â”‚   â”‚
â”‚  â”‚  - start() / stop()                              â”‚   â”‚
â”‚  â”‚  - persist()                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è®¿é—®æ•°æ®æºç®¡ç†

```
1. å¯åŠ¨ Admin: `python -m deva.admin`
2. è®¿é—®ï¼š`http://127.0.0.1:9999`
3. ç‚¹å‡» **ğŸ“¡ æ•°æ®æº** èœå•
```

### 2. åˆ›å»ºç¬¬ä¸€ä¸ªæ•°æ®æº

**æ–¹æ³• 1ï¼šæ‰‹åŠ¨åˆ›å»º**

```python
from deva.admin_ui.datasource import DataSource

class TimerDataSource(DataSource):
    """å®šæ—¶å™¨æ•°æ®æº"""
    
    def fetch_data(self):
        import time
        return {
            'timestamp': time.time(),
            'datetime': time.strftime('%Y-%m-%d %H:%M:%S')
        }
```

**æ–¹æ³• 2ï¼šAI ç”Ÿæˆ**

```
1. ç‚¹å‡» **ğŸ¤– AI ç”Ÿæˆæ•°æ®æº**
2. å¡«å†™éœ€æ±‚ï¼š
   - åç§°ï¼šè‚¡ç¥¨æ•°æ®æº
   - æè¿°ï¼šä» Yahoo Finance è·å–è‚¡ç¥¨æ•°æ®
   - æ•°æ®ç±»å‹ï¼šdict
   - æ›´æ–°é¢‘ç‡ï¼š5 ç§’
3. ç‚¹å‡» **ç”Ÿæˆä»£ç **
4. å®¡æŸ¥å¹¶ä¿å­˜
```

---

## ğŸ“‹ æ•°æ®æºç±»å‹

### 1. Timer æ•°æ®æº

å®šæ—¶æ‰§è¡Œï¼Œè¿”å›å›ºå®šæ•°æ®ã€‚

```python
class TimerDataSource(DataSource):
    def fetch_data(self):
        return {'count': self.counter}
```

### 2. HTTP æ•°æ®æº

ä» HTTP API è·å–æ•°æ®ã€‚

```python
class HTTPDataSource(DataSource):
    def fetch_data(self):
        import requests
        response = requests.get('https://api.example.com/data')
        return response.json()
```

### 3. æ–‡ä»¶æ•°æ®æº

ä»æ–‡ä»¶è¯»å–æ•°æ®ã€‚

```python
class FileDataSource(DataSource):
    def fetch_data(self):
        with open('data.txt', 'r') as f:
            return f.read()
```

### 4. æ•°æ®åº“æ•°æ®æº

ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ã€‚

```python
class DatabaseDataSource(DataSource):
    def fetch_data(self):
        import sqlite3
        conn = sqlite3.connect('data.db')
        df = pd.read_sql('SELECT * FROM table', conn)
        return df.to_dict()
```

---

## ğŸ¤– AI ä»£ç ç”Ÿæˆ

### æ”¯æŒçš„æ•°æ®æºç±»å‹

1. **API æ•°æ®æº**
   - REST API
   - GraphQL
   - WebSocket

2. **æ–‡ä»¶æ•°æ®æº**
   - CSV æ–‡ä»¶
   - JSON æ–‡ä»¶
   - Excel æ–‡ä»¶

3. **æ•°æ®åº“æ•°æ®æº**
   - SQLite
   - MySQL
   - PostgreSQL

4. **æ¶ˆæ¯é˜Ÿåˆ—**
   - Kafka
   - Redis Stream
   - RabbitMQ

### AI ç”Ÿæˆç¤ºä¾‹

**è¾“å…¥éœ€æ±‚ï¼š**
```
æ•°æ®æºåç§°ï¼šå¤©æ°”æ•°æ®æº
æ•°æ®æºæè¿°ï¼šä» OpenWeatherMap API è·å–å¤©æ°”æ•°æ®
æ•°æ®ç±»å‹ï¼šdict
æ›´æ–°é¢‘ç‡ï¼š60 ç§’
```

**ç”Ÿæˆçš„ä»£ç ï¼š**
```python
from deva.admin_ui.datasource import DataSource
import requests

class WeatherDataSource(DataSource):
    """å¤©æ°”æ•°æ®æº"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.api_key = 'your_api_key'
        self.city = 'Beijing'
    
    def fetch_data(self):
        """
        è·å–å¤©æ°”æ•°æ®
        
        Returns:
            dict: åŒ…å«æ¸©åº¦ã€æ¹¿åº¦ç­‰ä¿¡æ¯
        """
        try:
            url = f'http://api.openweathermap.org/data/2.5/weather'
            params = {
                'q': self.city,
                'appid': self.api_key,
                'units': 'metric'
            }
            
            response = requests.get(url, params=params)
            data = response.json()
            
            return {
                'temperature': data['main']['temp'],
                'humidity': data['main']['humidity'],
                'description': data['weather'][0]['description'],
                'timestamp': time.time()
            }
            
        except Exception as e:
            self.log.error(f'è·å–å¤©æ°”æ•°æ®å¤±è´¥ï¼š{e}')
            return None
```

---

## ğŸ’¾ æŒä¹…åŒ–

### æ•°æ®æºé…ç½®å­˜å‚¨

```python
from deva import NB

# è·å–æ•°æ®æºå­˜å‚¨
datasource_store = NB('datasource_store', key_mode='explicit')

# ä¿å­˜æ•°æ®æºé…ç½®
datasource_store.upsert('weather_ds', {
    'name': 'weather_ds',
    'type': 'http',
    'code': '...',
    'config': {
        'url': 'http://api.openweathermap.org',
        'interval': 60
    },
    'created_at': '2026-02-26'
})

# è·å–æ•°æ®æºé…ç½®
config = datasource_store['weather_ds']

# åˆ—å‡ºæ‰€æœ‰æ•°æ®æº
datasources = list(datasource_store.keys())
```

### æ•°æ®æŒä¹…åŒ–

```python
from deva import DBStream

# åˆ›å»ºæ•°æ®å­˜å‚¨
data_store = DBStream('weather_data.db', 'weather')

# ä¿å­˜æ•°æ®
data_store.append({
    'temperature': 25.5,
    'humidity': 60,
    'timestamp': time.time()
})

# æŸ¥è¯¢æ•°æ®
for data in data_store[:100]:
    print(data)
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å®æ—¶æŒ‡æ ‡

- **è¿è¡ŒçŠ¶æ€**ï¼šè¿è¡Œä¸­/å·²åœæ­¢
- **æ•°æ®é¢‘ç‡**ï¼šæ¯ç§’æ•°æ®é‡
- **å“åº”æ—¶é—´**ï¼šå¹³å‡è·å–æ•°æ®æ—¶é—´
- **æˆåŠŸç‡**ï¼šæˆåŠŸè·å–æ•°æ®æ¯”ä¾‹

### ç»Ÿè®¡æŒ‡æ ‡

- **æ€»æ•°æ®é‡**ï¼šé‡‡é›†çš„æ•°æ®æ€»é‡
- **æˆåŠŸæ¬¡æ•°**ï¼šæˆåŠŸè·å–æ•°æ®æ¬¡æ•°
- **å¤±è´¥æ¬¡æ•°**ï¼šå¤±è´¥æ¬¡æ•°
- **å¹³å‡å“åº”æ—¶é—´**ï¼šå¹³å‡æ¯æ¬¡è·å–çš„æ—¶é—´

---

## ğŸ”§ é«˜çº§åŠŸèƒ½

### 1. æ•°æ®æºè¡€ç¼˜å…³ç³»

```python
# æŸ¥çœ‹æ•°æ®æºçš„ä¸Šä¸‹æ¸¸
from deva.admin_ui.datasource import get_ds_manager as get_datasource_manager

mgr = get_datasource_manager()

# è·å–æ•°æ®æºä¿¡æ¯
ds_info = mgr.get_datasource('weather_ds')

# æŸ¥çœ‹ä½¿ç”¨è¯¥æ•°æ®æºçš„ç­–ç•¥
strategies = ds_info.get('downstream_strategies', [])
print(f"ä½¿ç”¨è¯¥æ•°æ®æºçš„ç­–ç•¥ï¼š{strategies}")
```

### 2. æ•°æ®æºç‰ˆæœ¬ç®¡ç†

```python
# ä¿å­˜ç‰ˆæœ¬
mgr.save_version('weather_ds', version='1.0.0', comment='åˆå§‹ç‰ˆæœ¬')

# æŸ¥çœ‹ç‰ˆæœ¬å†å²
versions = mgr.get_versions('weather_ds')

# å›æ»š
mgr.rollback('weather_ds', version='1.0.0')
```

---

## âš ï¸ æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†

```python
class MyDataSource(DataSource):
    def fetch_data(self):
        try:
            # è·å–æ•°æ®
            data = self.get_data()
            return data
        except requests.Timeout:
            self.log.error('è¯·æ±‚è¶…æ—¶')
            return None
        except Exception as e:
            self.log.error(f'è·å–æ•°æ®å¤±è´¥ï¼š{e}', exc_info=True)
            return None
```

### 2. æ•°æ®éªŒè¯

```python
def fetch_data(self):
    data = self.get_data()
    
    # éªŒè¯æ•°æ®æ ¼å¼
    if not isinstance(data, dict):
        self.log.error('æ•°æ®æ ¼å¼é”™è¯¯')
        return None
    
    # éªŒè¯å¿…è¦å­—æ®µ
    required_fields = ['temperature', 'humidity']
    for field in required_fields:
        if field not in data:
            self.log.error(f'ç¼ºå°‘å­—æ®µï¼š{field}')
            return None
    
    return data
```

### 3. æ€§èƒ½ä¼˜åŒ–

```python
# ä½¿ç”¨ç¼“å­˜
from functools import lru_cache

class MyDataSource(DataSource):
    @lru_cache(maxsize=100)
    def get_cached_data(self, key):
        return self.fetch_from_api(key)
    
    def fetch_data(self):
        return self.get_cached_data('weather')
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæ•°æ®æºæ— æ³•å¯åŠ¨

**å¯èƒ½åŸå› ï¼š**
- ä»£ç æœ‰è¯­æ³•é”™è¯¯
- ç¼ºå°‘å¿…è¦çš„å¯¼å…¥
- é…ç½®å‚æ•°é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# 1. æ£€æŸ¥ä»£ç è¯­æ³•
python -m py_compile datasource.py

# 2. æ£€æŸ¥å¯¼å…¥
from deva.admin_ui.datasource import DataSource

# 3. æ£€æŸ¥é…ç½®
# åœ¨ Admin UI ä¸­æŸ¥çœ‹æ•°æ®æºé…ç½®
```

### é—®é¢˜ 2ï¼šæ•°æ®è·å–å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- ç½‘ç»œè¿æ¥é—®é¢˜
- API å¯†é’¥æ— æ•ˆ
- æ•°æ®æ ¼å¼é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ·»åŠ è¯¦ç»†æ—¥å¿—
def fetch_data(self):
    self.log.info('å¼€å§‹è·å–æ•°æ®')
    
    try:
        data = self.get_data()
        self.log.info(f'è·å–åˆ°æ•°æ®ï¼š{data}')
        return data
    except Exception as e:
        self.log.error(f'è·å–æ•°æ®å¤±è´¥ï¼š{e}', exc_info=True)
        raise
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç­–ç•¥ç®¡ç†](strategy_guide.md) - ç­–ç•¥ç®¡ç†
- [ä»»åŠ¡ç®¡ç†](task_guide.md) - ä»»åŠ¡ç®¡ç†
- [AI åŠŸèƒ½](ai_center_guide.md) - AI ä»£ç ç”Ÿæˆ

---

**æœ€åæ›´æ–°ï¼š** 2026-02-26  
**é€‚ç”¨ç‰ˆæœ¬ï¼š** Deva v1.4.1+
