# AI 代码创建器使用指南

## 概述

AI 代码创建器已集成到 Deva AI 功能中心的「代码创建」Tab 页，提供 AI 辅助创建数据源、策略、任务等功能。

## 访问方式

1. 打开 Deva 管理面板
2. 进入「AI 功能中心」
3. 选择「🛠️ 代码创建」Tab

## 功能模块

### 1. 数据源创建器

支持创建以下类型的数据源：

#### ⏱️ 定时器数据源
- **用途**: 定时获取数据（如每秒获取股票价格）
- **示例**: "每 5 秒获取一次 AAPL 股票价格"
- **配置项**:
  - 数据源名称
  - 功能描述
  - 更新间隔（秒）

#### 🌐 HTTP 数据源
- **用途**: 从 HTTP API 获取数据
- **示例**: "从 CoinGecko API 获取加密货币价格"
- **配置项**:
  - 数据源名称
  - 功能描述
  - API URL

#### 📁 文件数据源
- **用途**: 从文件读取数据
- **示例**: "读取 CSV 文件，解析为字典"
- **配置项**:
  - 数据源名称
  - 功能描述
  - 文件路径

#### 🔧 自定义数据源
- **用途**: 自定义逻辑获取数据
- **配置项**:
  - 数据源名称
  - 详细功能描述

### 2. 策略创建器

支持创建以下类型的量化策略：

#### 📈 均线策略
- **示例**: "双均线策略：5 日线上穿 20 日线买入，下穿卖出"
- **配置项**:
  - 策略名称
  - 策略描述
  - 短期均线周期
  - 长期均线周期

#### 📊 指标策略
- **示例**: "MACD 策略：金叉买入，死叉卖出"
- **配置项**:
  - 策略名称
  - 策略描述
  - 技术指标（MACD, RSI, KDJ 等）

#### 🔧 自定义策略
- **配置项**:
  - 策略名称
  - 详细策略逻辑描述

### 3. 任务创建器

支持创建定时任务：

- **示例**: 
  - "每天凌晨 2 点备份数据库"
  - "每小时检查一次系统状态"
- **配置项**:
  - 任务名称
  - 任务描述
  - 执行时间（如"每天 02:00"或"3600"秒）

### 4. 自定义代码创建器

支持创建通用代码：

- **代码类型**:
  - Python 通用代码
  - Deva 流处理
  - Deva 管道
  - 其他

## 使用流程

### 创建数据源

1. 点击「📈 创建数据源」
2. 选择数据源类型（定时器/HTTP/文件/自定义）
3. 填写配置信息
4. 点击「🤖 AI 生成代码」
5. 查看生成的代码
6. 点击「💾 保存并创建」直接保存到数据库

### 创建策略

1. 点击「📊 创建策略」
2. 选择策略类型（均线/指标/自定义）
3. 填写配置信息
4. 点击「🤖 AI 生成代码」
5. 查看生成的代码
6. 复制代码并前往「策略管理」页面手动创建

### 创建任务

1. 点击「⚙️ 创建任务」
2. 填写任务配置
3. 点击「🤖 AI 生成代码」
4. 查看生成的代码
5. 点击「💾 保存并创建」直接保存到任务系统

## 功能特点

### ✅ 已实现

- AI 辅助生成代码
- 支持多种数据源类型
- 支持多种策略类型
- 支持定时任务创建
- 一键保存到数据库（数据源/任务）
- 最近创建记录显示
- 代码复制功能

### 🔄 计划中

- 策略一键保存
- 代码预览和编辑
- 模板库
- 代码版本管理
- 批量创建

## 示例

### 示例 1：创建股票数据源

**需求**: 每 5 秒获取一次 AAPL 股票价格

**配置**:
```
数据源名称：AAPL 股价数据源
描述：每 5 秒从 Yahoo Finance 获取 AAPL 股票价格
更新间隔：5.0 秒
```

**生成代码**:
```python
from deva.admin_ui.strategy.datasource import DataSource, DataSourceType
import httpx

class AAPLPriceDataSource(DataSource):
    """AAPL 股票价格数据源"""
    
    async def fetch_data(self):
        """获取 AAPL 股票价格"""
        try:
            url = "https://query1.finance.yahoo.com/v8/finance/chart/AAPL"
            async with httpx.AsyncClient() as client:
                response = await client.get(url)
                data = response.json()
                
                price = data['chart']['result'][0]['meta']['regularMarketPrice']
                
                return {
                    'symbol': 'AAPL',
                    'price': price,
                    'timestamp': time.time()
                }
        except Exception as e:
            self.record_error(f"获取数据失败：{e}")
            return None
```

### 示例 2：创建双均线策略

**需求**: 双均线策略，5 日线上穿 20 日线买入，下穿卖出

**配置**:
```
策略名称：双均线策略
描述：当 5 日均线上穿 20 日均线时买入，下穿时卖出
短期均线：5
长期均线：20
```

### 示例 3：创建定时任务

**需求**: 每天凌晨 2 点备份数据库

**配置**:
```
任务名称：数据库备份
描述：每天凌晨 2 点备份 SQLite 数据库到指定目录
执行时间：每天 02:00
```

## 技术实现

### 架构

```
AI 代码创建器
├── 数据源创建器
│   ├── 定时器数据源
│   ├── HTTP 数据源
│   ├── 文件数据源
│   └── 自定义数据源
├── 策略创建器
│   ├── 均线策略
│   ├── 指标策略
│   └── 自定义策略
├── 任务创建器
│   └── 定时任务
└── 自定义代码创建器
    └── Python/Deva代码
```

### 依赖

- `deva.admin_ui.llm_service.get_gpt_response`: AI 代码生成
- `deva.admin_ui.strategy.datasource.DataSource`: 数据源创建
- `deva.admin_ui.strategy.strategy_unit.StrategyUnit`: 策略创建
- `deva.admin_ui.tasks`: 任务创建

## 常见问题

### Q: 生成的代码不准确怎么办？

A: 可以尝试：
1. 更详细地描述需求
2. 提供具体的示例
3. 手动调整生成的代码

### Q: 数据源创建后如何查看？

A: 前往「数据源管理」页面查看和管理已创建的数据源。

### Q: 策略创建后为什么不能直接保存？

A: 策略创建需要配置数据源、参数等，暂时需要手动在策略管理页面完成。

### Q: 如何修改已创建的代码？

A: 目前需要手动复制代码后修改，后续会添加在线编辑功能。

## 更新日志

### v1.0.0 (2026-02-26)
- ✅ 初始版本发布
- ✅ 数据源创建器
- ✅ 策略创建器
- ✅ 任务创建器
- ✅ 自定义代码创建器
- ✅ 集成到 AI Tab
